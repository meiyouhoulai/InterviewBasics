## 谈谈你对 Java 平台的理解，Java 是解释执行吗？

> 2019/2/22

#### Java

Java 本身是一种面向对象的语言，最显著的特性有两个方面：

- “书写一次，到处运行”，Java 通过字节码和 JVM 这种跨平台的抽象，非常容易地获得跨平台的能力。
- 垃圾收集，Java 通过垃圾收集器来回收和分配内存，无需程序员手动操作。

JRE：即 Java Runtime Environment，包含了 JVM 和 Java 类库以及一些模块等。

JDK：即 Java Development Kit，可以看做 JRE 的一个超集，提供了更多的工具，如编译器、各种诊断工具等。

#### Java 是解释执行吗？

不完全是。

我们写的 Java 源代码，首先通过 javac 编译成 .class 字节码，然后，在运行时，通过 JVM 内嵌的解释器将字节码转换为机器码执行。

但是常见的 JVM，比如我们大多数情况使用的 Oracle JDK 提供的 Hotspot JVM，都提供了 JIT 编译器，JIT 是 Just-In-Time 的意思，也就是即时编译器，JIT 能够在运行的时候将热点代码编译成机器码，这种情况下热点代码就属于编译执行，而不是解释执行了。

JVM 启动时，可以指定不同的参数对运行模式进行选择：

- -Xint：告诉 JVM 只进行解释执行，不对代码进行编译，这种模式抛弃了JIT 可能带来的性能优势，毕竟解释器是逐条读入，逐条解释运行的。
- -Xcomp：告诉 JVM 关闭解释器，不要进行解释执行，这种做法也叫做最大级别优化。这会导致 JVM 启动变慢，同时有些 JIT 编译器的优化，比如分支预测，如果不进行解析，往往不能有效优化。

#### 编译器和解释器各自的优点

解释器优点：当程序需要迅速启动的时候，解释器可以首先发挥作用，省去了编译的时间，立即执行。解释执行占用更小的内存空间。同时，当编译器进行的激进优化失败的时候，还可以进行逆优化来恢复到解释执行的状态。

编译器优点：在程序运行时，随着时间的推移，编译器逐渐发挥作用，把越来越多的代码编译成本地代码之后，可以获得更高的执行效率。

因此，整个虚拟机执行架构中，解释器与编译器经常配合工作。

#### AOT

Ahead-of-Time Compilation，一种新的 Java 编译模式，可以在运行前直接将字节码编译成机器码，这样可以避免 JIT 预热等各方面的开销。

比如 Oracle JDK 9 就引入了实验性的 AOT 特性，并增加了新的的 jaotc 工具。

#### 什么是热点代码？

简单而言就是运行特别频繁的代码。

当虚拟机发现某个方法或代码块的运行特别频繁的时候，就会把这些代码认定为 “热点代码”，为了提高其执行效率，在运行时，虚拟机会把这些代码编译成与本地平台相关的机器码，并进行各种层次的优化。

完成这个任务的编译器就是 JIT。

在运行过程中会被即时编译的 “热点代码” 有两类，即：

- 被多次调用的方法
- 被多次执行的循环体

对于第一种，编译器会将整个方法作为编译对象，这也是 **标准的 JIT 编译** 方式。

对于第二种是由循环体出发的，但是编译器依然会以整个方法作为编译对象，因为发生在方法执行过程中，称为 **栈上替换**。

#### Thanks

https://my.oschina.net/dlam/blog/468298

https://blog.csdn.net/zq602316498/article/details/39152349



