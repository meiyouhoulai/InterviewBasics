## HTTPS 的优化

> 2019/10/15

#### HTTPS 为什么慢

HTTPS 连接大致可以分为两个部分，第一个是建立连接时的非对称加密握手，第二个是握手后的对称加密报文传输。

目前流行的 AES、ChaCha20 性能都很好，报文传输的性能损耗非常小，所以说通常说 HTTPS 连接慢，指的是建立连接的这个过程。

在 TCP 建立连接之后，正式传输数据之前，HTTPS 比 HTTP 多了一个 TLS 握手的步骤，这个步骤除了网络耗时之外，还有一些加密解密的计算耗时。

#### 硬件优化

1. HTTPS 是连接密集型，我们可以使用更快的 CPU，最好还内建 AES 优化，这样可以加速握手。

2. 使用 SSL 加速服务器，让专门的服务器来做非对称加解密，分担 CPU 的压力。

#### 协议优化

1. 使用 TLS 1.3，它大幅度简化了握手过程，提高了性能。
2. 如不能使用 TLS 1.3，握手的时候密钥交换算法尽可能的使用 ECDHE 算法，它不经运算速度快，还支持 Fasle Start。
3. 椭圆曲线尽可能的选择高性能曲线，最好是 x25519，其次是 P-256

#### 证书优化

1. 选择椭圆曲线证书，而不是 RSA 证书，224 位的 ECC 相当于 2048 位的 RSA，所以椭圆曲线证书相对 RSA 要小很多，传输速度快，客户端的运算量也小。
2. OCSP 是在线证书状态协议，向 CA 发送查询请求，CA 会返回证书的有效转态，不过现在都使用 OCSP Stapling，它可以让服务器预先访问 CA 获取 OCSP 响应，然后在握手的时候随着证书一起发送给客户端，免去了客户端查询 CA 的时间。

#### 会话复用

原理：TLS 握手的的重点是计算出主密钥 “Master Secret”，而主密钥每次连接都要重新计算，如果能把它缓存起来就好了。

会话复用分两种：

1. Session ID：客户端和服务器在首次连接后各自保存一个会话 ID，将主密钥和其他相关信息保存在内存中，当客户端再次连接时发一个 ID 过来，服务器就在内存中找，找到后就直接用主密钥恢复会话状态。

2. 由于 Session ID 需要服务器保存为每个客户端都保存一份 ID，但是这样会加重服务器的负担。

   于是出现了第二  Session Ticket 方案，这个有点类似 HTTP 的 Cookie，存储的责任由服务器转移到了客户端，服务器加密会话信息，用 “New Session Ticket” 将 Ticket 发送给客户端，让客户端保存，重连的时候，客户端使用 “session_ticket” 将 Ticket 发送给服务器，服务器验证有效期后恢复会话，开始加密通信。

   不过 Session Tacket 需要一个固定的密钥文件 ( tacket_key ) 来加密 Ticket，为了防止密钥被破解，保证前向安全，需要定期轮换，比如一小时或者一天。

#### 预密钥共享

这种方式叫做 “Pre-shared Key” 简称 PSK，实际上是 Session Tacket 的强化版，在发送 Tacket 的时候会带上应用数据，省去了 Tacket 的验证步骤。



