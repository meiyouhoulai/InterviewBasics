## HTTP 的连接管理

> 2019/9/25

#### 长连接

短连接：每次发送请求前都需要和服务器建立连接，收到响应报文后会立即关闭连接。

长连接：在与服务器建立连接后，发送多个请求，接受多个响应，之后再关闭连接。

![](../resource/image/57b3d80234a1f1b8c538a376aa01d3b4.png)

在 HTTP/1.1 中长连接是默认开启的，当然我们也可以明确的要求使用长连接机制：**Connection:keep-alive**

如果服务器支持长连接，会在响应字段中放一个 **Connection:keep-alive** 告诉客户端，它是支持长连接的。

#### 长连接的关闭

在长连接的情况下，TCP 连接长时间不关闭，服务器必须在内存里保存它的状态，这就占用了服务器的资源，如果有大量空闲的长连接只连不发，会大量消耗服务器的资源，导致服务器无法对真正有需要的用户提供服务。

DDoS 就是利用 HTTP 长连接的特性对服务器发起大量的请求，导致服务器资源耗尽 “ 拒绝服务 ”。

长连接的关闭策略：

1. 客户端主动关闭，发送 **Connection:close** 字段，服务器看到这个字段，就知道客户端要主动关闭长连接，然后会在响应报文中也加上这个字段，接着调用 Socket API 关闭长连接。
2. Nginx 服务器可以使用 keepalive_timeout 指令，设置长连接的超时时间，如果在一段时间内，没有任何数据的收发，就主动断开长连接。
3. Nginx 服务器可以使用 keepalive_timeout 指令，设置长连接上可发送的最大请求次数。比如设置了 1000，当服务处理了 1000 个请求后，也会主动断开长连接。

#### 队首阻塞

队首阻塞与长连接短连接没有关系，是由 HTTP 经典的 “请求-应答” 模型导致的。

HTTP 规定报文必须是 “ 一收一发 ”，这就形成了一个先进先出的 “ 串行 ” 队列，只有队列中前面的请求被处理后，后面的请求才能够被处理。如果队首的请求处理太慢，队列后面的请求也会被阻塞。

#### 队首阻塞优化

- 并发连接：对一个域名发起多个长连接
- 域名分片：多开几个域名指向同一台主机，比如一个浏览器限制一个域名最多 6 个长连接，那么开三个域名，就可以拥有 18 个长连接，这里是客户端优化的概念。

