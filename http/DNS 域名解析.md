## DNS 域名解析

> 2019/9/18

我们知道，DNS 提供了域名和 IP 地址之间的解析服务。

那么具体的解析过程是怎样的呢？

#### DNS 的核心系统

DNS 的核心系统是一个三层树状的结构：

![](../resource/image/6b020454987543efdd1cf6ddec784bf2.png)

1. 根域名服务器（根 DNS）：管理顶级域名服务器，返回 com、cn、net 等顶级域名服务器的 IP 地址
2. 顶级域名服务器：管理各自域名下的权威域名服务器，比如 com 的顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址
3. 权威域名服务器：一个二级域名就要有一个对应的权威域名服务器，用来管理自己域名下主机的 IP 地址，比如 apple.com 的权威域名服务器可以返回 www.apple.com 的 IP 地址

根域名服务器是众所周知的，目前全世界共有 13 组根域名服务器，又有数百台镜像。

任何一个域名都可以在 DNS 这个树形结构中自顶向下查询，比如 www.apple.com

1. 访问根服务器，它会告诉你 com 顶级域名的 IP 地址
2. 访问 com 顶级域名服务器，它会告诉你 apple.com 域名服务器的地址
3. 最后访问 apple.com 域名服务器，就得到了 www.apple.com 的 IP 地址

所谓的域名劫持，就是你要查询 A 网址的 IP 地址，结果 DNS 给了你一个 B 网址的 IP 地址；

域名屏蔽就是 DNS 对域名直接不解析，返回错误，让你无法拿到 IP 地址，也就无法访问网站（ 比如 GFW ）。

#### 减轻域名解析压力

减轻域名解析压力的核心思路是「缓存」

1. 许多公司都会建立自己的 DNS 服务器，作为用户 DNS 的查询代理，这些被称作「非权威 DNS 服务器」，代替用户访问核心的 DNS 系统，这些服务器可以缓存之前的查询结果，如果已经有了记录，就无需向根 DNS 服务器发起查询，直接返回对应的 IP 地址。

   注意，这里域名解析有一个的有效期，到期就会去上一级dns重新获取，当然也可以主动刷新。

2. 操作系统也会对 DNS 的解析结果做缓存，如果之前访问过 www.apple.com，那么下一次在浏览器中输入这个网址就不用去 DNS 那里访问了，直接在操作系统里就可以拿到 IP 地址。

   另外，操作系统里面还有一个 hosts 文件，如果操作系统里在缓存里找不到 DNS 的记录，就会找这个文件，hosts 文件的目的是方便用户自己添加 DNS 解析，它不是缓存，是一个简单的解析器。

3. 浏览器缓存，目前大多数的浏览器都会对 DNS 进行缓存。

总结：浏览器缓存 -> 操作系统缓存 -> hosts -> 非权威 DNS 服务器 -> DNS

#### 关于 DNS 的负载均衡

- DNS 解析可以返回多个 IP 地址，所以一个域名可以对应多个主机，当客户端收到多个 IP 地址后，可以使用自己的轮训算法一次想不同的服务器发起请求，实现负载均衡。
- DNS 解析是可以配置一些策略，返回离客户端最近的主机，或者返回当前质量最好的主机，这样可以在 DNS 端将请求分发到不同的服务器，实现负责均衡。