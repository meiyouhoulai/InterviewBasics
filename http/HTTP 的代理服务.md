## HTTP 的代理服务

> 2019/10/8

#### 什么是 HTTP 代理

在客户端和服务器原本的通信链路中插入一个中间环节，也是一台服务器，但是提供代理服务。

![](../resource/image/28237ef93ce0ddca076d2dc19c16fdf9.png)

链条的起点还是客户端，中间角色被称为代理服务器（proxy server），链条的终点被称为源服务器（origin sever），意思是数据的 "源头"、“起源”。

代理服务器本身不产生内容，而是出于中间位置转发上下游的请求和响应，具有双重身份：

- 面向下游用户时，表现为服务器，代表源服务器响应客户端的请求
- 面向上游的源服务器时，表现为客户端，代表客户端发送请求

#### 代理的作用

1. 欺上瞒下：代理对上屏蔽了真实客户端，对下屏蔽了真实服务器，在这个中间层可以做很多事情，为 HTTP 协议提供更多的灵活性，实现客户端和服务器的双赢。
2. 负载均衡：代理面向客户端时屏蔽的源服务器，客户端看到的只是代理服务器，源服务器有多少台、IP 地址这些都不知道，于是代理服务器就可以拥有分发的权利，决定由后面哪台服务器响应请求。
3. 健康检查：利用 “心跳” 等机制监控后端服务器，发现故障就及时 “踢出” 集群，保证服务高可用。
4. 安全防护：保护被代理的后端服务器，限制 IP 地址或流量，抵御网络攻击和过载。
5. 加密卸载：对外网使用 SSL/TLS 加密通信认证，而在安全的内网不加密，消除加密成本。
6. 数据过滤：拦截上下行的数据，任意指定策略修改请求或者响应。
7. 内容缓存：暂存、复用服务器响应。

#### 代理的相关字段

1. Via：通用字段，在请求头或者响应头里面都可以出现，用来标识代理服务器的信息，每经过一个代理都会在字段后面追加一个代理主机名或者域名信息。

   ![](../resource/image/52a3bd760584972011f6be1a5258e2d7.png)

   Via 解决了客户端和服务器之间是否存在代理的问题，但是无法知道对方的真实信息。

2. X-Forwarded-For：这个字段不是 HTTP 提供的标准字段，约定俗称的字段，为谁转发，使用方法和 Via 一样，也是每经过一个代理节点就追加一个信息，但是 Via 追加的是代理主机名或者域名，而 X-Forwarded-For 追加的是请求放的 IP 地址。

3. X-Real-IP：用来记录客户端的 IP 地址，没有中间的代理信息，相当于 X-Forwarded-For 的简化版，如果客户端和源服务器之间只有一个代理，那么两个字段的值是相同的。

#### 代理协议

通过 “X-Forwarded-For” 操作代理信息必须要解析 HTTP 报文头，这对代理来说成本比较高，原本只要简答的转发消息就好，现在必须费时费力的解析数据，会降低代理的转发性能。

于是就专门出现了一个代理协议：The PROXY protocol，它在 HTTP 报文前面增加了一行 ASCII 码的文本，相当于又多了一个头。

开头是 PROXY 五个大写字母，然后是 TCP4 或者 TCP6 表示客户端的 IP 地址类型；

再后面是请求方地址、应答方地址、请求方端口号、应答方端口号。

注意这一行是代理服务器加上去的。

```http
PROXY TCP4 1.1.1.1 2.2.2.2 55555 80\r\n
GET / HTTP/1.1\r\n
Host: www.xxx.com\r\n
\r\n
```

服务器看到这样报文，只要解析第一行就能拿到客户端的地址，不用再解析后的 HTTP 报文了。

不过代理协议并不支持“X-Forwarded-For”的链式地址形式，所以拿到客户端地址后再如何处理就需要代理服务器与后端自行约定。

#### 代理的缺点

增加链路长度

如果在代理上做一些复杂的处理，会很耗费性能